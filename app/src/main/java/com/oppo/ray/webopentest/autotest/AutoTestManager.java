package com.oppo.ray.webopentest.autotest;

import android.os.Environment;
import android.os.Handler;
import android.os.HandlerThread;
import android.os.Message;
import android.util.Log;

import com.oppo.ray.webopentest.BuildConfig;
import com.oppo.ray.webopentest.utils.ShellUtils;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Locale;

public class AutoTestManager {
    private static final String TAG = AutoTestManager.class.getSimpleName();
    private static final boolean DEBUG = BuildConfig.DEBUG;

    private static AutoTestManager sInstance;
    private HandlerThread mHandlerThread;
    private File mScreenShortDir;
    private SimpleDateFormat mDateFormat;

    private static final int MSG_TAKE_CAPTURE = 1;

    private static final String PREFIX = "screenshot_";

    private Handler mHandler;
    private Handler.Callback mCallback = new Handler.Callback() {
        @Override
        public boolean handleMessage(Message msg) {
            switch (msg.what) {
                case MSG_TAKE_CAPTURE: {
                    captureInner();
                    //mHandler.sendEmptyMessageDelayed(MSG_TAKE_CAPTURE, 1000);
                    return true;
                }
            }
            return false;
        }
    };

    public static AutoTestManager getInstance() {
        if (null == sInstance) {
            synchronized (AutoTestManager.class) {
                if (null == sInstance) {
                    sInstance = new AutoTestManager();
                }
            }
        }
        return sInstance;
    }

    private AutoTestManager() {
        mHandlerThread = new HandlerThread("BackgroundThread");
        mHandlerThread.start();
        mHandler = new Handler(mHandlerThread.getLooper(), mCallback);
        File file = Environment.getExternalStorageDirectory();
        String dir = file.getAbsolutePath() + "/ColorOS/Browser/WebOpenTest/";
        mScreenShortDir = new File(dir);
        if (!mScreenShortDir.isDirectory()) {
            mScreenShortDir.mkdirs();
        }
        mDateFormat = new SimpleDateFormat("yyyy-MM-dd-HH:mm:ss.SSSZ", Locale.getDefault());
    }

    public void capture() {
        mHandler.sendEmptyMessageDelayed(MSG_TAKE_CAPTURE, 4000);
    }

    private void captureInner() {
        String fileName = getFileName();
        File output = new File(mScreenShortDir, fileName);
        Log.e(TAG, String.format("mScreenShortDir[%s], fileName=[%s]", mScreenShortDir, fileName));
        if (!output.isFile()) {
            try {
                output.createNewFile();
                String fullName = output.getAbsolutePath();
                String cmd = String.format("/system/bin/screencap -p %s", fullName);
                ShellUtils.execCommand(cmd, true);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    private String getFileName() {
        return String.format("%s%s.png", PREFIX, mDateFormat.format(new Date()));
    }

    public void onDestroy() {
        if (null != mHandlerThread) {
            mHandlerThread.quitSafely();
        }
    }
}
