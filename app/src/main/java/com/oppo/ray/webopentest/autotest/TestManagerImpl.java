package com.oppo.ray.webopentest.autotest;

import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.os.Environment;
import android.os.Handler;
import android.os.HandlerThread;
import android.os.Message;
import android.util.Log;

import com.oppo.ray.webopentest.BuildConfig;
import com.oppo.ray.webopentest.utils.ShellUtils;
import com.oppo.ray.webopentest.utils.Utils;

import java.io.File;
import java.text.SimpleDateFormat;
import java.util.List;
import java.util.Locale;

/**
 * 需求清单
 * 轮数-----可选择测试轮数
 * Url文件-----可选择apk路径TestUrl下面保存的url文件，可选择要
 * 执行延时----默认选择3s，根据实际情况，可选择1—10s
 * 浏览器----可选择手机上已经按照的浏览器执行，如QQ浏览器、OPPO浏览器等
 * 运行----点击运行，即可自动启动浏览器，依次打开对应URL文件里面的站点
 * 停止----点击停止自动化操作
 * 文件位置----点击可进入TestUrl文件夹目录下面
 * 刷新----有URL文件更换时可操作
 * 日志显示-----显示打开第几个站点，站点的url
 */
public class TestManagerImpl implements ITestManager {
    private static final String TAG = TestManagerImpl.class.getSimpleName();
    private static final boolean DEBUG = BuildConfig.DEBUG;

    private static final String URLS_PATH = "TestUrl";
    private static final String PREFIX = "screenshot_";
    private static final int MSG_TAKE_CAPTURE = 1;
    private static final int MSG_START = 2;
    private static final int MSG_PAUSE = 3;
    private static final int MSG_STOP = 4;
    private static final int MSG_START_TEST = 5;
    private static final int MSG_UPDATE_TIMES = 6;

    /**
     * single instance
     */
    private static ITestManager sInstance;
    /**
     * background thread
     */
    private final HandlerThread mHandlerThread;
    /**
     * the dir use to save screen shot
     */
    private final File mScreenShortDir;
    /**
     * the urls dir
     */
    private final File mUrlsPath;

    /**
     * the current urls
     */
    private List<String> mCurrentUrls;
    private IProgressCallback mTestCallback;
    /**
     * the config for test
     */
    private TestConfiguration mConfig;
    /**
     * used to format date
     */
    private final SimpleDateFormat mDateFormat;
    private int mCurrentTimes = 0;
    /**
     * the current test url
     */
    private String mCurrentTestUrl;
    private int mCurrentTestIndex;

    private final Handler mHandler;
    private final Intent mStartIntent = new Intent();
    private Context mContext;
    private final Handler.Callback mCallback = new Handler.Callback() {
        @Override
        public boolean handleMessage(Message msg) {
            switch (msg.what) {
                case MSG_TAKE_CAPTURE: {
                    captureInner();
                    return true;
                }
                case MSG_PAUSE: {

                    break;
                }
                case MSG_START: {
                    startInner((TestConfiguration) msg.obj);
                    return true;
                }
                case MSG_STOP: {

                    break;
                }
                case MSG_START_TEST: {
                    testInner();
                    return true;
                }
                case MSG_UPDATE_TIMES: {
                    updateTimes();
                    break;
                }
            }
            return false;
        }
    };

    private void updateTimes() {
        int oldTimes = mCurrentTimes;
        this.mCurrentTestIndex = 0;
        this.mCurrentTimes++;
        if (null != mTestCallback) {
            mTestCallback.onTestTimes(oldTimes, mCurrentTimes);
        }
    }

    private void testInner() {
        //1.first open url use special browser
        startView(mConfig);

        //2.send capture msg
        mHandler.removeMessages(MSG_TAKE_CAPTURE);
        mHandler.sendMessageDelayed(mHandler.obtainMessage(MSG_TAKE_CAPTURE), mConfig.getmStartDelay());
    }

    private void startView(TestConfiguration configuration) {
        this.mCurrentTestUrl = mCurrentUrls.get(mCurrentTestIndex);
        String url = mCurrentTestUrl;
        int time = mCurrentTimes;
        if (DEBUG) {
            String msg = String.format("startView url[%s],time[%d]", url, mCurrentTimes);
            Log.w(TAG, msg);
        }

        if (null != mTestCallback) {
            mTestCallback.onTestUrl(url, time);
        }

        mStartIntent.setPackage(configuration.getmCurrentTestPackage());
        mStartIntent.setAction(Intent.ACTION_VIEW);
        //FIXME fix url
        mStartIntent.setData(Uri.parse("http://" + url));
        mStartIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        //mContext.startActivity(mStartIntent);

        //update execute time
        mCurrentTestIndex++;
    }

    public static ITestManager getInstance() {
        if (null == sInstance) {
            synchronized (TestManagerImpl.class) {
                if (null == sInstance) {
                    sInstance = new TestManagerImpl();
                }
            }
        }
        return sInstance;
    }

    private TestManagerImpl() {
        mHandlerThread = new HandlerThread("BackgroundThread");
        mHandlerThread.start();
        mHandler = new Handler(mHandlerThread.getLooper(), mCallback);
        File file = Environment.getExternalStorageDirectory();
        //TODO check sdcard state
        mUrlsPath = new File(file, URLS_PATH);
        String dir = file.getAbsolutePath() + "/ColorOS/Browser/WebOpenTest/";
        mScreenShortDir = new File(dir);
        if (!mScreenShortDir.isDirectory()) {
            mScreenShortDir.mkdirs();
        }
        mDateFormat = new SimpleDateFormat("yyyy-MM-dd-HH:mm:ss.SSSZ", Locale.getDefault());
    }

    @Override
    public void capture() {
        mHandler.sendEmptyMessageDelayed(MSG_TAKE_CAPTURE, 0);
    }


    private void captureInner() {
        //1.first capture
        File output = Utils.createFile(getUrlConfigDir(), mConfig, mCurrentTestUrl, getCurrentTimes());
        if (null == output) {
            Log.e(TAG, "create file failed return");
            return;
        }

        String absolutePath = output.getAbsolutePath();
        Log.e(TAG, String.format("fileAbsPath", absolutePath));

        String fullName = absolutePath;
        String cmd = String.format("/system/bin/screencap -p %s", fullName);
        ShellUtils.execCommand(cmd, true);

        //2.next test
        boolean isLast = mCurrentTestIndex == mCurrentUrls.size() - 1;
        boolean isFinished = mCurrentTimes == mConfig.getmTimes() && isLast;
        if (isFinished) {
            if (null != mTestCallback) {
                mTestCallback.onTestFinish();
            }

            if (DEBUG) {
                Log.d(TAG, "captureInner: finished");
            }
        }
        else {
            boolean currentTimeFinished = mCurrentTimes < mConfig.getmTimes() && isLast;
            if (currentTimeFinished) {
                mHandler.removeMessages(MSG_UPDATE_TIMES);
                mHandler.obtainMessage(MSG_UPDATE_TIMES).sendToTarget();
            }

            mHandler.removeMessages(MSG_START_TEST);
            mHandler.obtainMessage(MSG_START_TEST).sendToTarget();
        }
    }

    @Override
    public void setCallback(IProgressCallback callback) {
        this.mTestCallback = callback;
    }

    @Override
    public void pause() {
        mHandler.obtainMessage(MSG_PAUSE).sendToTarget();
        if (null != mTestCallback) {
            mTestCallback.onTestPause();
        }
    }

    @Override
    public void start(TestConfiguration configuration, Context context) {
        this.mContext = context;
        mHandler.obtainMessage(MSG_START, configuration).sendToTarget();
    }

    private void startInner(TestConfiguration configuration) {
        //1.first parse urls
        TestConfiguration oldConfig = mConfig;
        this.mConfig = configuration;
        if (null == oldConfig || !oldConfig.isSameConfigFile(configuration)) {
            this.mCurrentUrls = Utils.initUrls(mConfig);
        }
        else {
            if (DEBUG) {
                Log.w(TAG, "same config file");
            }
        }

        if (null == mCurrentUrls || mCurrentUrls.isEmpty()) {
            Log.e(TAG, "start return for urls is null or empty");
            return;
        }

        //2.start test
        mHandler.obtainMessage(MSG_UPDATE_TIMES).sendToTarget();
        mHandler.obtainMessage(MSG_START_TEST).sendToTarget();
    }

    @Override
    public void stop() {
        mHandler.obtainMessage(MSG_STOP).sendToTarget();
        if (null != mTestCallback) {
            mTestCallback.onTestStop();
        }
    }

    @Override
    public String getUrlConfigDir() {
        return mUrlsPath.getAbsolutePath();
    }


    public void onDestroy() {
        if (null != mHandlerThread) {
            mHandlerThread.quitSafely();
        }
    }

    @Override
    public int getCurrentTimes() {
        return mCurrentTimes;
    }
}
